#!/usr/bin/env python3
"""
Script de Prueba de Conexiones - Rexus.app
==========================================

Este script verifica que todas las conexiones a la base de datos
y funcionalidades implementadas funcionen correctamente.
"""

import sys
import os

# Agregar el directorio src al path para importar m√≥dulos
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from datetime import datetime, date
from src.core.database import InventarioDatabaseConnection, UsersDatabaseConnection, AuditoriaDatabaseConnection

# Importar los modelos implementados
try:
    from src.modules.administracion.recursos_humanos.model import RecursosHumanosModel
    from src.modules.administracion.contabilidad.model import ContabilidadModel
    from src.modules.mantenimiento.model import MantenimientoModel
    from src.modules.logistica.model import LogisticaModel
    print("[OK] Todos los modulos importados correctamente")
except ImportError as e:
    print(f"‚ùå Error importando m√≥dulos: {e}")
    sys.exit(1)


def test_database_connections():
    """Prueba las conexiones b√°sicas a las bases de datos."""
    print("\n" + "="*60)
    print("üîç PROBANDO CONEXIONES DE BASE DE DATOS")
    print("="*60)
    
    # Probar conexi√≥n a base de datos de inventario
    print("\nüìä Probando conexi√≥n a base de datos 'inventario'...")
    try:
        db_inventario = InventarioDatabaseConnection()
        if db_inventario._connection:
            print("‚úÖ Conexi√≥n a 'inventario' exitosa")
            
            # Probar una consulta simple
            cursor = db_inventario.cursor()
            cursor.execute("SELECT COUNT(*) FROM sysobjects WHERE xtype='U'")
            tabla_count = cursor.fetchone()[0]
            print(f"‚úÖ N√∫mero de tablas en 'inventario': {tabla_count}")
            cursor.close()
        else:
            print("‚ùå No se pudo conectar a 'inventario'")
            return False
    except Exception as e:
        print(f"‚ùå Error conectando a 'inventario': {e}")
        return False
    
    # Probar conexi√≥n a base de datos de usuarios
    print("\nüë• Probando conexi√≥n a base de datos 'users'...")
    try:
        db_users = UsersDatabaseConnection()
        if db_users._connection:
            print("‚úÖ Conexi√≥n a 'users' exitosa")
            
            # Probar una consulta simple
            cursor = db_users.cursor()
            cursor.execute("SELECT COUNT(*) FROM sysobjects WHERE xtype='U'")
            tabla_count = cursor.fetchone()[0]
            print(f"‚úÖ N√∫mero de tablas en 'users': {tabla_count}")
            cursor.close()
        else:
            print("‚ùå No se pudo conectar a 'users'")
    except Exception as e:
        print(f"‚ùå Error conectando a 'users': {e}")
    
    # Probar conexi√≥n a base de datos de auditor√≠a
    print("\nüìã Probando conexi√≥n a base de datos 'auditoria'...")
    try:
        db_auditoria = AuditoriaDatabaseConnection()
        if db_auditoria._connection:
            print("‚úÖ Conexi√≥n a 'auditoria' exitosa")
            
            # Probar una consulta simple
            cursor = db_auditoria.cursor()
            cursor.execute("SELECT COUNT(*) FROM sysobjects WHERE xtype='U'")
            tabla_count = cursor.fetchone()[0]
            print(f"‚úÖ N√∫mero de tablas en 'auditoria': {tabla_count}")
            cursor.close()
        else:
            print("‚ùå No se pudo conectar a 'auditoria'")
    except Exception as e:
        print(f"‚ùå Error conectando a 'auditoria': {e}")
    
    return True


def test_recursos_humanos_model():
    """Prueba el modelo de Recursos Humanos."""
    print("\n" + "="*60)
    print("üë• PROBANDO MODELO DE RECURSOS HUMANOS")
    print("="*60)
    
    try:
        # Crear conexi√≥n y modelo
        db = InventarioDatabaseConnection()
        model = RecursosHumanosModel(db)
        
        print("‚úÖ Modelo de Recursos Humanos inicializado correctamente")
        
        # Probar obtener empleados
        print("\nüìã Probando obtener empleados...")
        empleados = model.obtener_todos_empleados()
        print(f"‚úÖ Empleados obtenidos: {len(empleados)} registros")
        
        # Probar estad√≠sticas
        print("\nüìä Probando estad√≠sticas de empleados...")
        estadisticas = model.obtener_estadisticas_empleados()
        print(f"‚úÖ Estad√≠sticas obtenidas: {len(estadisticas)} elementos")
        
        # Probar c√°lculo de n√≥mina
        print("\nüí∞ Probando c√°lculo de n√≥mina...")
        nomina = model.calcular_nomina(datetime.now().month, datetime.now().year)
        print(f"‚úÖ N√≥mina calculada: {len(nomina)} empleados")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error en modelo de Recursos Humanos: {e}")
        return False


def test_contabilidad_model():
    """Prueba el modelo de Contabilidad."""
    print("\n" + "="*60)
    print("üí∞ PROBANDO MODELO DE CONTABILIDAD")
    print("="*60)
    
    try:
        # Crear conexi√≥n y modelo
        db = InventarioDatabaseConnection()
        model = ContabilidadModel(db)
        
        print("‚úÖ Modelo de Contabilidad inicializado correctamente")
        
        # Probar obtener asientos contables
        print("\nüìä Probando obtener asientos contables...")
        asientos = model.obtener_asientos_contables()
        print(f"‚úÖ Asientos contables obtenidos: {len(asientos)} registros")
        
        # Probar obtener recibos
        print("\nüßæ Probando obtener recibos...")
        recibos = model.obtener_recibos()
        print(f"‚úÖ Recibos obtenidos: {len(recibos)} registros")
        
        # Probar estad√≠sticas financieras
        print("\nüìà Probando estad√≠sticas financieras...")
        estadisticas = model.obtener_estadisticas_financieras()
        print(f"‚úÖ Estad√≠sticas financieras obtenidas: {len(estadisticas)} elementos")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error en modelo de Contabilidad: {e}")
        return False


def test_mantenimiento_model():
    """Prueba el modelo de Mantenimiento."""
    print("\n" + "="*60)
    print("üîß PROBANDO MODELO DE MANTENIMIENTO")
    print("="*60)
    
    try:
        # Crear conexi√≥n y modelo
        db = InventarioDatabaseConnection()
        model = MantenimientoModel(db)
        
        print("‚úÖ Modelo de Mantenimiento inicializado correctamente")
        
        # Probar obtener equipos
        print("\n‚öôÔ∏è Probando obtener equipos...")
        equipos = model.obtener_equipos()
        print(f"‚úÖ Equipos obtenidos: {len(equipos)} registros")
        
        # Probar obtener herramientas
        print("\nüî® Probando obtener herramientas...")
        herramientas = model.obtener_herramientas()
        print(f"‚úÖ Herramientas obtenidas: {len(herramientas)} registros")
        
        # Probar obtener mantenimientos
        print("\nüìÖ Probando obtener mantenimientos...")
        mantenimientos = model.obtener_mantenimientos()
        print(f"‚úÖ Mantenimientos obtenidos: {len(mantenimientos)} registros")
        
        # Probar estad√≠sticas
        print("\nüìä Probando estad√≠sticas de mantenimiento...")
        estadisticas = model.obtener_estadisticas_mantenimiento()
        print(f"‚úÖ Estad√≠sticas de mantenimiento obtenidas: {len(estadisticas)} elementos")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error en modelo de Mantenimiento: {e}")
        return False


def test_logistica_model():
    """Prueba el modelo de Log√≠stica."""
    print("\n" + "="*60)
    print("üöö PROBANDO MODELO DE LOG√çSTICA")
    print("="*60)
    
    try:
        # Crear conexi√≥n y modelo
        db = InventarioDatabaseConnection()
        model = LogisticaModel(db)
        
        print("‚úÖ Modelo de Log√≠stica inicializado correctamente")
        
        # Probar obtener transportes
        print("\nüöõ Probando obtener transportes...")
        transportes = model.obtener_transportes()
        print(f"‚úÖ Transportes obtenidos: {len(transportes)} registros")
        
        # Probar obtener entregas
        print("\nüì¶ Probando obtener entregas...")
        entregas = model.obtener_entregas()
        print(f"‚úÖ Entregas obtenidas: {len(entregas)} registros")
        
        # Probar obtener obras disponibles
        print("\nüèóÔ∏è Probando obtener obras disponibles...")
        obras = model.obtener_obras_disponibles()
        print(f"‚úÖ Obras disponibles obtenidas: {len(obras)} registros")
        
        # Probar estad√≠sticas
        print("\nüìä Probando estad√≠sticas de log√≠stica...")
        estadisticas = model.obtener_estadisticas_logistica()
        print(f"‚úÖ Estad√≠sticas de log√≠stica obtenidas: {len(estadisticas)} elementos")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error en modelo de Log√≠stica: {e}")
        return False


def test_table_existence():
    """Verifica qu√© tablas existen en la base de datos."""
    print("\n" + "="*60)
    print("üóÑÔ∏è VERIFICANDO EXISTENCIA DE TABLAS")
    print("="*60)
    
    try:
        db = InventarioDatabaseConnection()
        cursor = db.cursor()
        
        # Obtener todas las tablas de usuario
        cursor.execute("""
            SELECT name 
            FROM sysobjects 
            WHERE xtype='U' 
            ORDER BY name
        """)
        
        tablas = [row[0] for row in cursor.fetchall()]
        
        print(f"\nüìã Tablas existentes en la base de datos 'inventario' ({len(tablas)}):")
        for tabla in tablas:
            print(f"   ‚úÖ {tabla}")
        
        # Verificar tablas espec√≠ficas que necesitamos
        tablas_requeridas = [
            'empleados', 'departamentos', 'asistencias', 'nomina', 'bonos_descuentos', 'historial_laboral',
            'libro_contable', 'recibos', 'pagos_obra', 'pagos_materiales',
            'equipos', 'herramientas', 'mantenimientos', 'programacion_mantenimiento',
            'transportes', 'entregas', 'detalle_entregas',
            'obras', 'inventario_perfiles'
        ]
        
        print(f"\nüîç Verificando tablas requeridas por los m√≥dulos implementados:")
        tablas_faltantes = []
        
        for tabla in tablas_requeridas:
            if tabla in tablas:
                print(f"   ‚úÖ {tabla} - EXISTE")
            else:
                print(f"   ‚ùå {tabla} - FALTANTE")
                tablas_faltantes.append(tabla)
        
        if tablas_faltantes:
            print(f"\n‚ö†Ô∏è ATENCI√ìN: {len(tablas_faltantes)} tablas requeridas no existen:")
            for tabla in tablas_faltantes:
                print(f"   - {tabla}")
            print(f"\nüí° Consulta el archivo 'docs/TABLAS_ADICIONALES_REQUERIDAS.md' para crear estas tablas")
        else:
            print(f"\nüéâ ¬°Todas las tablas requeridas existen!")
        
        cursor.close()
        return True
        
    except Exception as e:
        print(f"‚ùå Error verificando tablas: {e}")
        return False


def main():
    """Funci√≥n principal que ejecuta todas las pruebas."""
    print("üöÄ INICIANDO PRUEBAS DE CONEXI√ìN Y FUNCIONALIDAD - REXUS.APP")
    print("=" * 80)
    print(f"üìÖ Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 80)
    
    resultados = []
    
    # Ejecutar todas las pruebas
    pruebas = [
        ("Conexiones de Base de Datos", test_database_connections),
        ("Verificaci√≥n de Tablas", test_table_existence),
        ("Modelo de Recursos Humanos", test_recursos_humanos_model),
        ("Modelo de Contabilidad", test_contabilidad_model),
        ("Modelo de Mantenimiento", test_mantenimiento_model),
        ("Modelo de Log√≠stica", test_logistica_model)
    ]
    
    for nombre_prueba, funcion_prueba in pruebas:
        try:
            resultado = funcion_prueba()
            resultados.append((nombre_prueba, resultado))
        except Exception as e:
            print(f"‚ùå Error cr√≠tico en {nombre_prueba}: {e}")
            resultados.append((nombre_prueba, False))
    
    # Mostrar resumen final
    print("\n" + "="*80)
    print("üìä RESUMEN DE RESULTADOS")
    print("="*80)
    
    exitosas = 0
    fallidas = 0
    
    for nombre, resultado in resultados:
        if resultado:
            print(f"‚úÖ {nombre}: EXITOSO")
            exitosas += 1
        else:
            print(f"‚ùå {nombre}: FALLIDO")
            fallidas += 1
    
    print(f"\nüìà ESTAD√çSTICAS FINALES:")
    print(f"   ‚úÖ Pruebas exitosas: {exitosas}")
    print(f"   ‚ùå Pruebas fallidas: {fallidas}")
    print(f"   üìä Total de pruebas: {len(resultados)}")
    print(f"   üìà Porcentaje de √©xito: {(exitosas/len(resultados)*100):.1f}%")
    
    if fallidas == 0:
        print(f"\nüéâ ¬°TODAS LAS PRUEBAS FUERON EXITOSAS!")
        print(f"‚úÖ El sistema est√° listo para usar")
    else:
        print(f"\n‚ö†Ô∏è Se encontraron {fallidas} problemas que requieren atenci√≥n")
        print(f"üí° Revisa los mensajes de error arriba para m√°s detalles")
    
    print("="*80)


if __name__ == "__main__":
    main()