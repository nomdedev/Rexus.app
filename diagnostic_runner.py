#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Diagnostic Runner - Analizador de Errores del Sistema
Identifica y cataloga los 263 errores reportados por el usuario
"""

import sys
import os
import traceback
import logging
from datetime import datetime

# Configurar paths del proyecto
project_root = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, project_root)
sys.path.insert(0, os.path.join(project_root, 'rexus'))

# Configurar logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('diagnostic_errors.log', encoding='utf-8'),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger("DiagnosticRunner")

class SystemDiagnostic:
    """Ejecuta diagn√≥sticos del sistema para identificar errores."""
    
    def __init__(self):
        self.errors_found = []
        self.modules_tested = []
        self.warnings_found = []
        
    def run_module_import_test(self):
        """Prueba importaci√≥n de todos los m√≥dulos principales."""
        
        modules_to_test = [
            'rexus.core.database_manager',
            'rexus.core.module_manager', 
            'rexus.core.auth_manager',
            'rexus.modules.configuracion.controller',
            'rexus.modules.configuracion.model',
            'rexus.modules.configuracion.view',
            'rexus.modules.usuarios.controller',
            'rexus.modules.usuarios.model',
            'rexus.modules.usuarios.view',
            'rexus.modules.inventario.controller',
            'rexus.modules.inventario.model',
            'rexus.modules.inventario.view',
            'rexus.modules.obras.controller',
            'rexus.modules.obras.model',
            'rexus.modules.obras.view',
            'rexus.modules.compras.controller',
            'rexus.modules.compras.model',
            'rexus.modules.compras.view',
            'rexus.modules.pedidos.controller',
            'rexus.modules.pedidos.model',
            'rexus.modules.pedidos.view',
            'rexus.modules.vidrios.controller',
            'rexus.modules.vidrios.model',
            'rexus.modules.vidrios.view',
            'rexus.modules.notificaciones.controller',
            'rexus.modules.notificaciones.model',
            'rexus.modules.notificaciones.view'
        ]
        
        logger.info("üîç INICIANDO PRUEBAS DE IMPORTACI√ìN DE M√ìDULOS")
        logger.info("=" * 60)
        
        for module_name in modules_to_test:
            try:
                logger.info(f"Testing: {module_name}")
                __import__(module_name)
                logger.info(f"‚úÖ {module_name} - OK")
                self.modules_tested.append((module_name, "SUCCESS"))
                
            except ImportError as e:
                error_msg = f"‚ùå {module_name} - ImportError: {str(e)}"
                logger.error(error_msg)
                self.errors_found.append(f"IMPORT_ERROR: {module_name} - {str(e)}")
                self.modules_tested.append((module_name, "IMPORT_ERROR"))
                
            except Exception as e:
                error_msg = f"‚ö†Ô∏è {module_name} - Error: {str(e)}"
                logger.warning(error_msg)
                self.errors_found.append(f"MODULE_ERROR: {module_name} - {str(e)}")
                self.modules_tested.append((module_name, "ERROR"))
    
    def run_database_connectivity_test(self):
        """Prueba conectividad de base de datos."""
        
        logger.info("\nüóÑÔ∏è INICIANDO PRUEBAS DE CONECTIVIDAD DE BD")
        logger.info("=" * 60)
        
        try:
            from rexus.core.database_manager import DatabaseManager
            
            # Probar conexi√≥n SQLite
            try:
                db_manager = DatabaseManager()
                db_manager.initialize_database()
                logger.info("‚úÖ Conexi√≥n SQLite - OK")
                
            except Exception as e:
                error_msg = f"‚ùå Conexi√≥n SQLite fall√≥: {str(e)}"
                logger.error(error_msg)
                self.errors_found.append(f"DB_SQLITE_ERROR: {str(e)}")
            
            # Probar conexi√≥n SQL Server si est√° configurada
            try:
                if hasattr(db_manager, 'connect_sql_server'):
                    db_manager.connect_sql_server()
                    logger.info("‚úÖ Conexi√≥n SQL Server - OK")
                else:
                    logger.info("‚ö†Ô∏è SQL Server no configurado")
                    
            except Exception as e:
                error_msg = f"‚ö†Ô∏è SQL Server no disponible: {str(e)}"
                logger.warning(error_msg)
                self.warnings_found.append(f"DB_SQLSERVER_WARNING: {str(e)}")
                
        except Exception as e:
            error_msg = f"‚ùå DatabaseManager no disponible: {str(e)}"
            logger.error(error_msg)
            self.errors_found.append(f"DB_MANAGER_ERROR: {str(e)}")
    
    def run_ui_component_test(self):
        """Prueba componentes de UI y dependencias."""
        
        logger.info("\nüñ•Ô∏è INICIANDO PRUEBAS DE COMPONENTES UI")
        logger.info("=" * 60)
        
        ui_components = [
            'PyQt6.QtWidgets',
            'PyQt6.QtCore', 
            'PyQt6.QtGui',
            'PyQt6.QtWebEngineWidgets'
        ]
        
        for component in ui_components:
            try:
                __import__(component)
                logger.info(f"‚úÖ {component} - OK")
                
            except ImportError as e:
                error_msg = f"‚ùå {component} - Faltante: {str(e)}"
                logger.error(error_msg)
                self.errors_found.append(f"UI_DEPENDENCY_ERROR: {component} - {str(e)}")
    
    def run_controller_instantiation_test(self):
        """Prueba instanciaci√≥n de controladores principales."""
        
        logger.info("\nüéÆ INICIANDO PRUEBAS DE CONTROLADORES")
        logger.info("=" * 60)
        
        controllers_to_test = [
            ('configuracion', 'rexus.modules.configuracion.controller', 'ConfiguracionController'),
            ('usuarios', 'rexus.modules.usuarios.controller', 'UsuariosController'),
            ('inventario', 'rexus.modules.inventario.controller', 'InventarioController'),
            ('obras', 'rexus.modules.obras.controller', 'ObrasController'),
            ('compras', 'rexus.modules.compras.controller', 'ComprasController'),
            ('pedidos', 'rexus.modules.pedidos.controller', 'PedidosController'),
            ('vidrios', 'rexus.modules.vidrios.controller', 'VidriosController'),
            ('notificaciones', 'rexus.modules.notificaciones.controller', 'NotificacionesController')
        ]
        
        for module_name, module_path, class_name in controllers_to_test:
            try:
                logger.info(f"Testing controller: {module_name}")
                
                # Importar m√≥dulo
                module = __import__(module_path, fromlist=[class_name])
                controller_class = getattr(module, class_name)
                
                # Intentar instanciar (puede fallar por dependencias)
                try:
                    controller = controller_class()
                    logger.info(f"‚úÖ {module_name} Controller - OK")
                    
                except Exception as e:
                    logger.warning(f"‚ö†Ô∏è {module_name} Controller - Error instanciaci√≥n: {str(e)}")
                    self.warnings_found.append(f"CONTROLLER_INSTANTIATION: {module_name} - {str(e)}")
                
            except ImportError as e:
                error_msg = f"‚ùå {module_name} Controller - ImportError: {str(e)}"
                logger.error(error_msg)
                self.errors_found.append(f"CONTROLLER_IMPORT_ERROR: {module_name} - {str(e)}")
                
            except AttributeError as e:
                error_msg = f"‚ùå {module_name} Controller - Clase no encontrada: {str(e)}"
                logger.error(error_msg)
                self.errors_found.append(f"CONTROLLER_CLASS_ERROR: {module_name} - {str(e)}")
    
    def generate_comprehensive_report(self):
        """Genera reporte completo de errores encontrados."""
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        report_file = f"DIAGNOSTIC_REPORT_{timestamp}.md"
        
        report_content = f"""# REPORTE DIAGN√ìSTICO DEL SISTEMA - {datetime.now().strftime("%d/%m/%Y %H:%M:%S")}

## üìä RESUMEN EJECUTIVO

- **Total Errores Cr√≠ticos:** {len(self.errors_found)}
- **Total Advertencias:** {len(self.warnings_found)}
- **M√≥dulos Analizados:** {len(self.modules_tested)}
- **An√°lisis Realizado:** {timestamp}

## ‚ùå ERRORES CR√çTICOS IDENTIFICADOS

"""
        
        for i, error in enumerate(self.errors_found, 1):
            report_content += f"{i}. {error}\n"
        
        report_content += f"""
## ‚ö†Ô∏è ADVERTENCIAS DEL SISTEMA

"""
        
        for i, warning in enumerate(self.warnings_found, 1):
            report_content += f"{i}. {warning}\n"
        
        report_content += f"""
## üìã ESTADO DE M√ìDULOS

| M√≥dulo | Estado | Observaciones |
|--------|--------|--------------|
"""
        
        for module, status in self.modules_tested:
            icon = "‚úÖ" if status == "SUCCESS" else "‚ùå" if status == "IMPORT_ERROR" else "‚ö†Ô∏è"
            report_content += f"| {module} | {icon} {status} | - |\n"
        
        report_content += f"""
## üéØ PLAN DE CORRECCI√ìN RECOMENDADO

### Prioridad Alta
1. **Dependencias Faltantes:** Instalar PyQt6-WebEngine y otras dependencias cr√≠ticas
2. **Errores de Importaci√≥n:** Corregir m√≥dulos con ImportError
3. **Conectividad BD:** Verificar configuraci√≥n de base de datos

### Prioridad Media  
4. **Controladores:** Corregir instanciaci√≥n de controladores
5. **Configuraci√≥n:** Completar m√≥dulos de configuraci√≥n y usuarios

### Prioridad Baja
6. **Advertencias:** Resolver warnings menores del sistema

## üìà M√âTRICAS DE CALIDAD

- **Tasa de √âxito de Importaci√≥n:** {(len([m for m in self.modules_tested if m[1] == 'SUCCESS']) / len(self.modules_tested) * 100):.1f}%
- **Errores Cr√≠ticos por M√≥dulo:** {len(self.errors_found) / len(self.modules_tested):.2f}
- **Estabilidad del Sistema:** {'BAJA' if len(self.errors_found) > 20 else 'MEDIA' if len(self.errors_found) > 10 else 'ALTA'}

---
*Reporte generado autom√°ticamente por DiagnosticRunner*
"""
        
        # Escribir reporte
        with open(report_file, 'w', encoding='utf-8') as f:
            f.write(report_content)
            
        logger.info(f"\nüìã REPORTE COMPLETO GENERADO: {report_file}")
        return report_file
    
    def run_full_diagnostic(self):
        """Ejecuta diagn√≥stico completo del sistema."""
        
        logger.info("üöÄ INICIANDO DIAGN√ìSTICO COMPLETO DEL SISTEMA")
        logger.info("=" * 80)
        logger.info(f"Timestamp: {datetime.now()}")
        logger.info(f"Python: {sys.version}")
        logger.info(f"Working Directory: {os.getcwd()}")
        logger.info("=" * 80)
        
        # Ejecutar todas las pruebas
        self.run_module_import_test()
        self.run_database_connectivity_test()
        self.run_ui_component_test()
        self.run_controller_instantiation_test()
        
        # Generar reporte
        report_file = self.generate_comprehensive_report()
        
        logger.info("\n" + "=" * 80)
        logger.info("üèÅ DIAGN√ìSTICO COMPLETO FINALIZADO")
        logger.info("=" * 80)
        logger.info(f"üìä RESUMEN:")
        logger.info(f"   - Errores cr√≠ticos encontrados: {len(self.errors_found)}")
        logger.info(f"   - Advertencias del sistema: {len(self.warnings_found)}")
        logger.info(f"   - M√≥dulos analizados: {len(self.modules_tested)}")
        logger.info(f"   - Reporte generado: {report_file}")
        
        return {
            'errors': self.errors_found,
            'warnings': self.warnings_found,
            'modules_tested': self.modules_tested,
            'report_file': report_file
        }

def main():
    """Funci√≥n principal del diagn√≥stico."""
    
    try:
        diagnostic = SystemDiagnostic()
        results = diagnostic.run_full_diagnostic()
        
        print(f"\nüéØ DIAGN√ìSTICO COMPLETADO")
        print(f"Total de errores identificados: {len(results['errors'])}")
        print(f"Reporte detallado: {results['report_file']}")
        
        return len(results['errors'])
        
    except Exception as e:
        logger.error(f"Error cr√≠tico en diagn√≥stico: {str(e)}")
        logger.error(traceback.format_exc())
        return -1

if __name__ == "__main__":
    error_count = main()
    sys.exit(error_count if error_count > 0 else 0)